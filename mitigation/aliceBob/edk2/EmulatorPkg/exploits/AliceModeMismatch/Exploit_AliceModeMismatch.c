#include <Library/ShellLib.h>
#include <Library/UefiBootServicesTableLib.h>
#include <Library/UefiLib.h>
#include <Protocol/LoadedImage.h>
#include <Protocol/Shell.h>
#include <Protocol/ShellParameters.h>
#include <Uefi.h>

#include "../../Demo1_Access_Key/Demo1_Access_Key.h"
#include "../../Demo1_Alice/Demo1_Alice.h"
#include "../../Demo1_Bob/Demo1_Bob.h"

Demo1_Access_Key_PROTOCOL *AccessKeyAPI;
Demo1_Bob_PROTOCOL *BobAPI;

#define EXAMPLEAPP_VARNAME L"ExampleVar"

void printAliceModeStatus(UINTN mode) {
  switch (mode) {
  case INIT_MODE:
    Print(L"Alice's shared variable is set to INIT\n");
    break;
  case RUN_MODE:
    Print(L"Alice's shared variable is set to RUN\n");
    break;
  default:
    Print(L"Alice's shared variable is in an inconsistent mode: 0x%x", mode);
    break;
  }
}

EFI_STATUS
EFIAPI
ExploitInit(IN EFI_HANDLE imgHandle, IN EFI_SYSTEM_TABLE *sysTable) {
  EFI_STATUS retStatus;
  UINTN aliceMode = 0;
  UINTN aliceModeSize = sizeof(aliceMode);
  DEMO1_ACCESS_KEY *key = AllocatePool(sizeof(DEMO1_ACCESS_KEY));

  gBS = sysTable->BootServices;
  gBS->SetWatchdogTimer(0, 0, 0, NULL);
  gBS->LocateProtocol(&gDemo1BobProtocolGuid, NULL, (VOID *)&BobAPI);
  gBS->LocateProtocol(&gDemo1AccessKeyProtocolGuid, NULL,
                      (VOID *)&AccessKeyAPI);

  Print(L"Generating access key with write permissions\n");
  retStatus =
      AccessKeyAPI->Demo1GenerateAccessKey(AccessKeyAPI, NULL, TRUE, key);

  if (EFI_ERROR(retStatus)) {
    Print(L"Could not generate key. Exiting.\n");
    return EFI_ABORTED;
  }

  Print(L"Reading Alice's mode\n");
  retStatus = sysTable->RuntimeServices->GetAccessVariable(
      ALICEMODE_VARNAME, &gAliceVariableGuid, NULL, key, &aliceModeSize,
      &aliceMode);

  if (EFI_ERROR(retStatus)) {
    DEBUG((DEBUG_ERROR, "%a: variable '%s' could not be read. Exiting.\n",
           __FUNCTION__, ALICEMODE_VARNAME));
    return retStatus;
  }

  printAliceModeStatus(aliceMode);

  Print(L"Setting Alice's mode to 0\n");
  aliceMode = 0;

  retStatus = sysTable->RuntimeServices->SetAccessVariable(
      ALICEMODE_VARNAME, &gAliceVariableGuid,
      EFI_VARIABLE_BOOTSERVICE_ACCESS | EFI_VARIABLE_RUNTIME_ACCESS |
          EFI_VARIABLE_NON_VOLATILE,
      key, aliceModeSize, &aliceMode);

  if (EFI_ERROR(retStatus)) {
    DEBUG((DEBUG_ERROR, "%a: variable '%s' could not be written. Exiting.\n",
           __FUNCTION__, ALICEMODE_VARNAME));
    return retStatus;
  }

  printAliceModeStatus(aliceMode);

  return EFI_SUCCESS;
}
